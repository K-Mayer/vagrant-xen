---
- name: Install Libvirt package
  package:
    name: libvirt-daemon-system
    state: present
  when: not xen_src

# TODO: Improve rebuild conditions
- include: libvirt_source.yml
  when: xen_src and (xen_force_build or git_xen is changed)

- name: Add user to libvirt group
  user:
    name: vagrant
    groups: libvirt
    append: yes

- name: Ensure libvirt daemon is started
  service:
    name: libvirtd
    state: started
    enabled: yes

- name: Install libvirt module requirements
  package:
    name:
      - python-libvirt
      - python-lxml

- name: Undefine default network
  community.libvirt.virt_net:
    command: undefine
    name: default
    uri: "xen:///"

- name: Redefine default network
  community.libvirt.virt_net:
    command: define
    name: default
    xml: '{{ lookup("file", "net-default.xml") }}'
    uri: "xen:///"

- name: Start default network
  community.libvirt.virt_net:
    name: default
    state: active
    autostart: yes
    uri: "xen:///"

- name: Define new directory pool
  community.libvirt.virt_pool:
    command: define
    name: default
    xml: '{{ lookup("file", "pool.xml") }}'
    uri: "xen:///"

- name: Build pool
  community.libvirt.virt_pool:
    command: build
    name: default
    uri: "xen:///"

- name: Activate pool
  community.libvirt.virt_pool:
    name: default
    state: active
    autostart: yes
    uri: "xen:///"
