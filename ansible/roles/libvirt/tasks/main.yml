---
- name: Install Libvirt package
  package:
    name: libvirt-daemon-system
    state: present
  when: not xen_src

# TODO: Improve rebuild conditions
- include: libvirt_source.yml
  when: xen_src and (xen_force_build or git_xen is changed)

- name: Add user to libvirt group
  user:
    name: vagrant
    groups: libvirt
    append: yes

- name: Ensure libvirt daemon is started
  service:
    name: libvirtd
    state: started

- name: Set default network as autostart
  command: virsh -c xen:/// net-autostart default

- name: Ensure default libvirt network is started
  command: virsh -c xen:/// net-start default
  register: libvirt_network_start
  failed_when: libvirt_network_start.rc != 0 and "already in use" not in libvirt_network_start.stderr

- name: Define libvirt pool
  command: virsh -c xen:/// pool-define-as default --type dir --target /data/images
  register: libvirt_pool_define
  failed_when: libvirt_pool_define.rc != 0 and "already exists" not in libvirt_pool_define.stderr

- name: Build libvirt pool
  command: virsh -c xen:/// pool-build default
  register: libvirt_pool_build
  failed_when: libvirt_pool_build.rc != 0 and "already active" not in libvirt_pool_build.stderr

- name: Set libvirt pool as autostart
  command: virsh -c xen:/// pool-autostart default

- name: Ensure libvirt pool is started
  command: virsh -c xen:/// pool-start default
  register: libvirt_pool_start
  failed_when: libvirt_pool_start.rc != 0 and "already active" not in libvirt_pool_start.stderr
